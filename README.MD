# Микросервис получения данных от пользователя

## Описание

Этот микросервис предоставляет функциональность для:
- Аутентификации пользователей (JWT токены)
- Управления пользовательскими данными (резюме, требования, результаты обработки)
- Кэширования данных с использованием Redis
- Асинхронной обработки событий через Kafka
- Взаимодействия с PostgreSQL базой данных

## Основные функции
- Хранение и управление данными:
  - Пользователи (`User`)
  - Резюме (`Resume`)
  - Требования (`Requirements`)
  - Результаты обработки (`Processing`)
- Кеширование данных в Redis
- Синхронизация данных между сервисами через Kafka

## Технологический стек

- **Python 3.13.3**
- **FastAPI** + **Uvicorn**
- **SQLAlchemy (async)** - работа с базой данных
- **PostgreSQL** - основное хранилище данных
- **Redis** - кэширование
- **Kafka** + **confluent-kafka**
- **Pydantic** - валидация данных
- **JWT** - аутентификация
- **Pytest** - тестирование

## Запуск сервиса

### Требования
- Docker и Docker Compose
- Python 3.10+

### Установка
1. Клонируйте репозиторий
2. Выполните: `pip install -r requirements.txt`
3. Создайте файл `.env` и `.test.env` (для тестирования) на основе `.env.example`
4. Заполните необходимые переменные окружения

### Запуск
```bash
docker-compose up -d
```

Сервис будет доступен по адресу: `http://localhost:8001`

## API Endpoints

### Работа с данными
| Метод | Эндпоинт                 | Описание                                        |
|-------|--------------------------|-------------------------------------------------|
| POST  | `/create_requirements/text` | создание требований (текст)                   |
| POST  | `/create_requirements/file` | создание требований (файл)                    |
| POST  | `/create_resume/text`      | создание резюме (текст)                        |
| POST  | `/create_resume/file`      | создание резюме (файл)                         |
| POST  | `/start_processing`        | запуск обработки резюме                        |
| POST  | `/delete_processing`       | удаление обработок                             |
| POST  | `/delete_requirements`     | удаление требований и связанных обработок      |

## Конфигурация
Основные настройки сервиса находятся в:
- `srt/config.py` - основные параметры сервиса
- `.env` - переменные окружения

## Тестирование
Для запуска тестов:
```bash
pytest
```
Для запуска тестов через Docker:
```bash
docker-compose --env-file .test.env up -d 
```
```bash
docker-compose --env-file .test.env exec app pytest
```

Тесты покрывают:
- Unit-тесты основных функций
- Интеграционные тесты API
- Тесты работы с Kafka
- Тесты работы с Redis и PostgreSQL

## Логирование
Логи сохраняются в файл `logs/auth_service.log` с ротацией по дням.

## Данные, получаемые с Kafka

- Читает по топику `uploading_data`
  - `new_user` - создание нового пользователя
  
- Отправляет по топику `uploading_data`:
  - `new_resume` - создание нового резюме
  - `new_requirements` - создание новых требований
  - `delete_processing` - удаление обработок
  - `delete_requirements` - удаление требований
  - `new_processing` - результаты обработки от AI

- Отправляет по топику `AI_handler`:
  - `new_request` - запрос на обработку к AI

## Хранение данных в Redis

### 1. Данные пользователя
**Ключ:** `user:{user_id}`  
**Значение:**
```json
{
  "user_id": int
}
```  
**TTL:** `ACCESS_TOKEN_EXPIRE_MINUTES * 60` (время жизни токена в секундах)

### 2. Данные требований
**Ключ:** `requirements:{requirements_id}`  
**Значение:** Текст требований (строка)  
**TTL:** `STORAGE_TIME_REQUIREMENTS` (3 дня)

### 3. Данные резюме
**Ключ:** `resume:{resume_id}`  
**Значение:** Текст резюме (строка)  
**TTL:** `STORAGE_TIME_RESUME` (1 час)

### 4. Данные для ограничения запросов
**Ключ:**  
- `start_processing:{user_id}` - счетчик запросов  
- `start_processing_bloc:{user_id}` - блокировка при превышении лимита  
**Значение:**  
- Для счетчика: количество запросов (int)  
- Для блокировки: любое значение (используется факт наличия ключа)  
**TTL:**  
- Для счетчика: 60 секунд  
- Для блокировки: `START_PROCESSING_BLOCK_TIME` (30 секунд)


### Общий readme: https://github.com/IvanShankin/API_handler_resume_general_readme